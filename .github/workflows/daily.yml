name: ğŸ“Š Daily Report

on:
  # æ‰‹åŠ¨è§¦å‘ - åœ¨ GitHub ç½‘é¡µæˆ–é€šè¿‡ API è§¦å‘
  workflow_dispatch:
    inputs:
      steps:
        description: 'Yesterday steps count'
        required: false
        default: ''
        type: string
      sleep_hours:
        description: 'Last night sleep hours'
        required: false
        default: ''
        type: string

  # å¯é€‰:å®šæ—¶è§¦å‘ - æ¯å¤©æ—©ä¸Š 7:00 (åŒ—äº¬æ—¶é—´)
  # UTC æ—¶é—´ 23:00 = åŒ—äº¬æ—¶é—´ 07:00 (UTC+8)
  # å–æ¶ˆæ³¨é‡Šä¸‹é¢ä¸¤è¡Œå¯ç”¨å®šæ—¶ä»»åŠ¡
  # schedule:
  #   - cron: '0 23 * * *'

jobs:
  send-daily-report:
    name: ğŸ“Š ç”Ÿæˆå¹¶å‘é€æ¯æ—¥ç®€æŠ¥
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸš€ è¿è¡Œæ¯æ—¥ç®€æŠ¥è„šæœ¬
        env:
          # é€šçŸ¥å™¨é…ç½®
          NOTIFIER_TYPE: ${{ vars.NOTIFIER_TYPE || 'telegram' }}

          # Telegram é…ç½®
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

          # é’‰é’‰é…ç½®
          DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
          DINGTALK_SECRET: ${{ secrets.DINGTALK_SECRET }}

          # é£ä¹¦é…ç½®
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}

          # ä¼ä¸šå¾®ä¿¡é…ç½®
          WECOM_WEBHOOK: ${{ secrets.WECOM_WEBHOOK }}

          # åŠŸèƒ½å¼€å…³
          ENABLE_GITHUB_STATS: ${{ vars.ENABLE_GITHUB_STATS || 'true' }}
          ENABLE_XIAOMI_SPORT: ${{ vars.ENABLE_XIAOMI_SPORT || 'false' }}
          ENABLE_WEREAD: ${{ vars.ENABLE_WEREAD || 'false' }}
          ENABLE_DUOLINGO: ${{ vars.ENABLE_DUOLINGO || 'true' }}
          ENABLE_POEM: ${{ vars.ENABLE_POEM || 'true' }}

          # è‹¹æœå¥åº·æ•°æ®ï¼ˆä» workflow input ä¼ å…¥ï¼‰
          APPLE_HEALTH_STEPS: ${{ inputs.steps }}
          APPLE_HEALTH_SLEEP_HOURS: ${{ inputs.sleep_hours }}

          # GitHub ç»Ÿè®¡
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_USERNAME: ${{ github.repository_owner }}

          # å°ç±³è¿åŠ¨ (å¦‚æœå¯ç”¨)
          XIAOMI_USERNAME: ${{ secrets.XIAOMI_USERNAME }}
          XIAOMI_PASSWORD: ${{ secrets.XIAOMI_PASSWORD }}

          # å¾®ä¿¡è¯»ä¹¦ (å¦‚æœå¯ç”¨)
          WEREAD_COOKIE: ${{ secrets.WEREAD_COOKIE }}

          # å¤šé‚»å›½
          DUOLINGO_USERNAME: ${{ secrets.DUOLINGO_USERNAME }}
          DUOLINGO_JWT_TOKEN: ${{ secrets.DUOLINGO_JWT_TOKEN }}
        run: |
          python main.py

      - name: ğŸ“ è®°å½•æ‰§è¡Œç»“æœ
        if: always()
        run: |
          if [ $? -eq 0 ]; then
            echo "âœ… æ¯æ—¥ç®€æŠ¥å‘é€æˆåŠŸ!"
          else
            echo "âŒ æ¯æ—¥ç®€æŠ¥å‘é€å¤±è´¥,è¯·æŸ¥çœ‹æ—¥å¿—"
            exit 1
          fi

      - name: ğŸš¨ å‘é€å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=âŒ æ¯æ—¥ç®€æŠ¥ç”Ÿæˆå¤±è´¥!%0A%0Aè¯·æŸ¥çœ‹ GitHub Actions æ—¥å¿—:%0Ahttps://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            -d "parse_mode=Markdown"
